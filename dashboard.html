<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>JD — Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js">
  
</script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root{ --accent1:#2614e618; --accent2:#00f2fe; }
  body{ background: linear-gradient(180deg,#f3f7fb, #eef6ff); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto; }
  .nav-top{ background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#002; box-shadow:0 6px 18px rgba(64,110,255,0.12); }
  .card{ border-radius:14px; }
  .profile-pic{ width:110px;height:110px;border-radius:50%;object-fit:cover;border:4px solid #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.08);}
  .floating { animation: floaty 4s ease-in-out infinite; }
  @keyframes floaty{ 0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)} }
  .badge-nutr{ font-size:0.9rem; padding:0.45rem 0.6rem; border-radius:10px; background:linear-gradient(90deg,#fff 0%, rgba(255,255,255,0.6) 100%); box-shadow:0 6px 20px rgba(2,6,23,0.04) }
  .muted{ color:#50607a; }
  .small-muted{ color:#7b8aa3; font-size:0.9rem }
  .input-compact{ padding:0.6rem 0.75rem; border-radius:10px; }
  /* small responsive tweak */
  @media (max-width:900px){ .profile-pic{ width:96px;height:96px } }
</style>
</head>
<body>
  <!-- top nav -->
  <nav class="navbar nav-top">
    <div class="container-fluid px-4 py-3 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <div style="width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;font-weight:700;color:#002">JD</div>
        <div>
          <div style="font-weight:700;color:#002">JD — Health & Nutrition</div>
          <div class="small-muted">Proteins • Vitamins • Minerals • Calories</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-3">
        <button id="darkToggle" class="btn btn-sm btn-light">Dark</button>
        <button class="btn btn-sm btn-white" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container mt-4 mb-5">
    <div class="row g-4">
      <!-- PROFILE -->
      <div class="col-lg-4">
        <div class="card p-4 shadow-sm">
          <div class="text-center">
            <img id="profileImg" class="profile-pic floating" src="" alt="profile">
            <h4 id="profileName" class="mt-2 mb-0">—</h4>
            <div class="small-muted">Welcome back</div>
          </div>

          <hr>
          <div>
            <h6 class="mb-2">Edit profile</h6>
            <label class="small-muted">Upload photo</label>
            <input id="filePic" type="file" accept="image/*" class="form-control mt-1" />

            <label class="form-label mt-3">Display name</label>
            <input id="editName" class="form-control input-compact" />

            <label class="form-label mt-2">Age</label>
            <input id="editAge" type="number" class="form-control input-compact" />

            <div class="d-grid mt-3">
              <button id="saveProfile" class="btn btn-primary">Save profile</button>
            </div>
          </div>

          <hr>
          <!-- BMI -->
          <div>
            <h6 class="mb-2">BMI Calculator</h6>
            <div class="row g-2">
              <div class="col-6">
                <input id="height" placeholder="Height (cm)" type="number" class="form-control input-compact" />
              </div>
              <div class="col-6">
                <input id="weight" placeholder="Weight (kg)" type="number" class="form-control input-compact" />
              </div>
            </div>
            <div class="d-grid mt-2">
              <button id="bmiBtn" class="btn btn-outline-primary">Calculate BMI</button>
            </div>
            <p id="bmiResult" class="mt-2 fw-bold"></p>
          </div>
        </div>
      </div>

      <!-- MAIN: stats, activity form, chart -->
      <div class="col-lg-8">
        <div class="card p-3 shadow-sm mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Today's summary</h5>
              <div class="small-muted">Add activity or nutrition to update the dashboard</div>
            </div>
            <div class="small-muted">Today: <span id="todayDate"></span></div>
          </div>

          <div class="row text-center mt-3 g-3">
            <div class="col-sm-6 col-md-3">
              <div class="badge-nutr shadow-sm p-3">
                <div class="muted">Steps</div>
                <div id="cardSteps" class="h5">0</div>
                <div class="small-muted">goal: 8000</div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="badge-nutr shadow-sm p-3">
                <div class="muted">Calories</div>
                <div id="cardCalories" class="h5">0 kcal</div>
                <div class="small-muted">goal: 2200 kcal</div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="badge-nutr shadow-sm p-3">
                <div class="muted">Protein</div>
                <div id="cardProtein" class="h5">0 g</div>
                <div class="small-muted">goal: 100 g</div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="badge-nutr shadow-sm p-3">
                <div class="muted">Water</div>
                <div id="cardWater" class="h5">0</div>
                <div class="small-muted">glasses</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity form -->
        <div class="card p-3 shadow-sm mb-3">
          <h6>Add / update today's activity & nutrition</h6>
          <form id="activityForm" class="row g-2 mt-2">
            <div class="col-sm-6 col-md-3">
              <input id="inputSteps" type="number" class="form-control" placeholder="Steps" required />
            </div>
            <div class="col-sm-6 col-md-3">
              <input id="inputCalories" type="number" class="form-control" placeholder="Calories (kcal)" required />
            </div>
            <div class="col-sm-6 col-md-3">
              <input id="inputProtein" type="number" class="form-control" placeholder="Protein (g)" required />
            </div>
            <div class="col-sm-6 col-md-3">
              <input id="inputWater" type="number" class="form-control" placeholder="Water (glasses)" required />
            </div>

            <div class="col-12">
              <input id="inputVitamins" class="form-control" placeholder="Vitamins / Minerals notes (e.g., multivitamin)" />
            </div>

            <div class="col-12 d-grid">
              <button class="btn btn-success">Save activity</button>
            </div>
          </form>
        </div>

        <!-- Chart -->
        <div class="card p-3 shadow-sm">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Weekly steps</h6>
            <small class="small-muted">Shows last 7 days</small>
          </div>
          <canvas id="stepsChart" height="120" class="mt-3"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
/* Helper: storage keys */
function getLoggedUser(){ return JSON.parse(localStorage.getItem('jdLoggedInUser')||'null'); }
function setLoggedUser(u){ localStorage.setItem('jdLoggedInUser', JSON.stringify(u)); }
function logout(){ localStorage.removeItem('jdLoggedInUser'); window.location.href='login.html'; }

/* init: ensure user logged in */
const user = getLoggedUser();
if(!user){ alert('Please login first.'); window.location.href = 'login.html'; }

/* Elements */
const profileName = document.getElementById('profileName');
const profileImg = document.getElementById('profileImg');
const editName = document.getElementById('editName');
const editAge = document.getElementById('editAge');
const filePic = document.getElementById('filePic');
const saveProfile = document.getElementById('saveProfile');
const bmiBtn = document.getElementById('bmiBtn');
const bmiResult = document.getElementById('bmiResult');
const todayDate = document.getElementById('todayDate');

const cardSteps = document.getElementById('cardSteps');
const cardCalories = document.getElementById('cardCalories');
const cardProtein = document.getElementById('cardProtein');
const cardWater = document.getElementById('cardWater');

const activityForm = document.getElementById('activityForm');
const stepsChartCtx = document.getElementById('stepsChart');

const keyActivities = (email) => `jd_activities_${email}`;

/* show profile info */
function loadProfile(){
  profileName.textContent = user.name || 'User';
  editName.value = user.name || '';
  editAge.value = user.age || '';
  const img = user.profileImage || '';
  profileImg.src = img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220"><rect rx="40" width="100%" height="100%" fill="%23f3f7fb"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" fill="%238aa0c0" font-size="54">JD</text></svg>';
}
loadProfile();

/* profile save & upload */
filePic.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=> {
    profileImg.src = fr.result;
    user.profileImage = fr.result;
    // update stored users
    const users = JSON.parse(localStorage.getItem('jdUsers')||'[]');
    const idx = users.findIndex(u=>u.email===user.email);
    if(idx>=0){ users[idx].profileImage = fr.result; localStorage.setItem('jdUsers', JSON.stringify(users)); }
    setLoggedUser(user);
  };
  fr.readAsDataURL(f);
});

saveProfile.addEventListener('click', ()=>{
  user.name = editName.value || user.name;
  user.age = editAge.value || user.age;
  // update users list
  const users = JSON.parse(localStorage.getItem('jdUsers')||'[]');
  const idx = users.findIndex(u=>u.email === user.email);
  if(idx>=0){ users[idx] = {...users[idx], ...user}; localStorage.setItem('jdUsers', JSON.stringify(users)); }
  setLoggedUser(user);
  loadProfile();
  Swal.fire({ icon:'success', text:'Profile updated', timer:1400, showConfirmButton:false });
});

/* set today date */
const today = new Date();
todayDate.textContent = today.toLocaleDateString();

/* Activities: store per-user */
function loadActivities(){
  return JSON.parse(localStorage.getItem(keyActivities(user.email)) || '[]');
}
function saveActivities(arr){
  localStorage.setItem(keyActivities(user.email), JSON.stringify(arr));
}

/* Chart: last 7 days steps */
let chart;
function createChart(dataArr){
  const labels = dataArr.map(d=>d.date);
  const data = dataArr.map(d=>d.steps);
  if(chart) chart.destroy();
  chart = new Chart(stepsChartCtx, {
    type:'line',
    data: {
      labels, datasets: [{
        label:'Steps', data, tension:0.3, fill:true,
        borderColor:'#4facfe', backgroundColor:'rgba(79,172,254,0.18)', pointRadius:4
      }]
    },
    options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
  });
}

/* load dashboard summary from activities (show last record as "today") */
function refreshDashboard(){
  const activities = loadActivities();
  // show last (most recent) or zeros
  const last = activities.length? activities[activities.length-1] : null;
  chartData = []; // prepare last 7 days
  // We'll produce labels for last 7 calendar days; fill with 0 if no entry
  const last7 = [];
  for(let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(d.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    const found = activities.find(a=>a.date === ds);
    last7.push({ date: ds, steps: found? found.steps : 0 });
  }
  createChart(last7);

  cardSteps.textContent = (last? last.steps : 0);
  cardCalories.textContent = (last? last.calories + ' kcal' : '0 kcal');
  cardProtein.textContent = (last? last.protein + ' g' : '0 g');
  cardWater.textContent = (last? last.water : '0');
}
refreshDashboard();

/* Activity form submit */
activityForm.addEventListener('submit', function(e){
  e.preventDefault();
  const steps = parseInt(document.getElementById('inputSteps').value || 0);
  const calories = parseInt(document.getElementById('inputCalories').value || 0);
  const protein = parseInt(document.getElementById('inputProtein').value || 0);
  const water = parseInt(document.getElementById('inputWater').value || 0);
  const vitamins = document.getElementById('inputVitamins').value || '';

  // store entry for today (date as YYYY-MM-DD)
  const d = new Date(); const ds = d.toISOString().slice(0,10);
  let activities = loadActivities();
  // replace if today's exists
  const existingIndex = activities.findIndex(a=>a.date===ds);
  const entry = { date: ds, steps, calories, protein, water, vitamins };
  if(existingIndex>=0) activities[existingIndex] = entry;
  else activities.push(entry);

  // keep recent 30 only
  if(activities.length>30) activities = activities.slice(-30);
  saveActivities(activities);

  // success UI
  Swal.fire({ title:'Saved ✅', text:'Activity saved for today', icon:'success', confirmButtonColor:'#4facfe' });
  confetti({ particleCount:120, spread:70, origin:{y:0.6} });

  // clear form
  activityForm.reset();
  // refresh dashboard
  refreshDashboard();
});

/* BMI */
bmiBtn.addEventListener('click', ()=>{
  const h = parseFloat(document.getElementById('height').value);
  const w = parseFloat(document.getElementById('weight').value);
  if(!h || !w){ bmiResult.textContent = 'Enter height and weight'; return; }
  const bmi = (w / ((h/100)*(h/100))).toFixed(1);
  let cat = '';
  if(bmi < 18.5) cat = 'Underweight';
  else if(bmi < 25) cat = 'Normal';
  else if(bmi < 30) cat = 'Overweight';
  else cat = 'Obese';
  bmiResult.textContent = `BMI: ${bmi} — ${cat}`;
});

/* Dark mode toggle (simple) */
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('bg-dark-mode');
  if(document.body.classList.contains('bg-dark-mode')){
    document.body.style.background = 'linear-gradient(180deg,#071024, #001025)';
    darkToggle.textContent = 'Light';
    darkToggle.classList.remove('btn-light'); darkToggle.classList.add('btn-dark');
  } else {
    document.body.style.background = 'linear-gradient(180deg,#f3f7fb, #eef6ff)';
    darkToggle.textContent = 'Dark';
    darkToggle.classList.remove('btn-dark'); darkToggle.classList.add('btn-light');
  }
});
</script>
</body>
</html>
